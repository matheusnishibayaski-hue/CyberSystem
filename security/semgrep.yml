rules:
  # OWASP Top 10 Security Rules
  
  # A01:2021 – Broken Access Control
  - id: insecure-jwt-secret
    patterns:
      - pattern: |
          jwt.sign(..., $SECRET, ...)
      - pattern-not: |
          jwt.sign(..., process.env.JWT_SECRET, ...)
    message: JWT secret should come from environment variables
    severity: ERROR
    languages: [javascript]
    metadata:
      category: security
      owasp: "A01:2021 - Broken Access Control"
      cwe: "CWE-287: Improper Authentication"

  # A02:2021 – Cryptographic Failures
  - id: weak-crypto-algorithm
    patterns:
      - pattern-either:
          - pattern: crypto.createHash("md5")
          - pattern: crypto.createHash("sha1")
    message: Weak cryptographic hash function detected. Use SHA-256 or stronger.
    severity: ERROR
    languages: [javascript]
    metadata:
      category: security
      owasp: "A02:2021 - Cryptographic Failures"
      cwe: "CWE-327: Use of a Broken or Risky Cryptographic Algorithm"

  # A03:2021 – Injection
  - id: sql-injection
    patterns:
      - pattern-either:
          - pattern: $QUERY = "SELECT ... " + $VAR + " ..."
          - pattern: $QUERY = `SELECT ... ${$VAR} ...`
    message: Potential SQL injection. Use parameterized queries.
    severity: ERROR
    languages: [javascript]
    metadata:
      category: security
      owasp: "A03:2021 - Injection"
      cwe: "CWE-89: SQL Injection"

  # A05:2021 – Security Misconfiguration
  - id: hardcoded-secrets
    patterns:
      - pattern-either:
          - pattern: password = "..."
          - pattern: secret = "..."
          - pattern: api_key = "..."
          - pattern: token = "..."
    message: Hardcoded secret detected. Use environment variables.
    severity: ERROR
    languages: [javascript]
    metadata:
      category: security
      owasp: "A05:2021 - Security Misconfiguration"
      cwe: "CWE-798: Use of Hard-coded Credentials"

  # A07:2021 – Identification and Authentication Failures
  - id: weak-password-validation
    patterns:
      - pattern-either:
          - pattern: password.length < 8
          - pattern: password.length < 7
          - pattern: password.length < 6
          - pattern: password.length < 5
          - pattern: password.length < 4
          - pattern: password.length < 3
          - pattern: password.length < 2
          - pattern: password.length < 1
    message: Password minimum length should be at least 8 characters.
    severity: WARNING
    languages: [javascript]
    metadata:
      category: security
      owasp: "A07:2021 - Identification and Authentication Failures"
      cwe: "CWE-521: Weak Password Requirements"

  # General Security Issues
  - id: eval-usage
    pattern: eval(...)
    message: Use of eval() is dangerous and can lead to code injection.
    severity: ERROR
    languages: [javascript]
    metadata:
      category: security
      cwe: "CWE-95: Improper Neutralization of Directives in Dynamically Evaluated Code"

  - id: dangerous-http-methods
    patterns:
      - pattern-either:
          - pattern: app.delete(...)
          - pattern: app.put(...)
          - pattern: app.patch(...)
      - pattern-not-inside: |
          authMiddleware
          ...
          app.$METHOD(...)
    message: Dangerous HTTP method without authentication. Ensure proper authorization.
    severity: WARNING
    languages: [javascript]
    metadata:
      category: security

  # Removida regra missing-helmet-usage - difícil de detectar corretamente com pattern-not
  # O Helmet está sendo usado corretamente em src/server.js linha 15: app.use(helmet({...}))

  # Removida regra missing-rate-limit-usage - difícil de detectar corretamente com pattern-not  
  # O Rate Limit está sendo usado corretamente em src/server.js linhas 75-77: app.use(generalLimiter) e app.use('/api/auth/login', authLimiter)
