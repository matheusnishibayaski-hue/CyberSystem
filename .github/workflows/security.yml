name: Security Scan - Semgrep

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:

env:
  # ConfiguraÃ§Ã£o do Security Gate
  # true = quebra build se houver problemas crÃ­ticos
  # false = apenas alerta (recomendado para desenvolvimento)
  FAIL_ON_CRITICAL: false

jobs:
  security:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ðŸ” Instalar Semgrep
        run: pip install semgrep

      - name: ðŸ›¡ï¸ Rodar Semgrep (JSON)
        continue-on-error: true
        run: |
          semgrep --config=security/semgrep.yml --json src/ frontend/src/ > semgrep-result.json || true

      - name: ðŸ’¡ AnÃ¡lise e SugestÃµes de CorreÃ§Ã£o
        id: suggestions
        continue-on-error: true
        run: |
          if [ -f semgrep-result.json ]; then
            if [ "${{ env.FAIL_ON_CRITICAL }}" = "true" ]; then
              python scripts/semgrep_suggestions.py --file semgrep-result.json
            else
              python scripts/semgrep_suggestions.py --file semgrep-result.json --no-fail
            fi
          else
            echo "âš ï¸  Arquivo semgrep-result.json nÃ£o encontrado"
          fi

      - name: ðŸ“Š Gerar Resumo de SeguranÃ§a
        if: always()
        run: |
          if [ -f semgrep-result.json ]; then
            echo "## ðŸ›¡ï¸ AnÃ¡lise de SeguranÃ§a - Resumo" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            python3 << 'EOF'
          import json
          import sys
          
          try:
              with open('semgrep-result.json', 'r') as f:
                  results = json.load(f)
              
              findings = results.get('results', [])
              
              # Conta por severidade
              critical = sum(1 for f in findings if f.get('extra', {}).get('severity') == 'ERROR')
              warning = sum(1 for f in findings if f.get('extra', {}).get('severity') == 'WARNING')
              info = sum(1 for f in findings if f.get('extra', {}).get('severity') == 'INFO')
              total = len(findings)
              
              # Status
              if critical > 0:
                  status = 'critical'
                  emoji = 'ðŸ”´'
              elif warning > 0:
                  status = 'warning'
                  emoji = 'ðŸŸ '
              elif info > 0:
                  status = 'info'
                  emoji = 'ðŸ”µ'
              else:
                  status = 'clean'
                  emoji = 'âœ…'
              
              print(f"{emoji} **Status:** {status.upper()}")
              print("")
              print("| Severidade | Quantidade |")
              print("|-----------|------------|")
              print(f"| ðŸ”´ Alta/CrÃ­tica | {critical} |")
              print(f"| ðŸŸ  MÃ©dia | {warning} |")
              print(f"| ðŸ”µ Baixa | {info} |")
              print(f"| **Total** | **{total}** |")
              print("")
              
              if critical > 0:
                  print("âš ï¸ **ATENÃ‡ÃƒO:** Problemas crÃ­ticos detectados!")
                  print("")
                  print("ðŸ’¡ **AÃ§Ã£o recomendada:** Corrigir antes de fazer merge")
              elif warning > 0 or info > 0:
                  print("â„¹ï¸ Problemas de mÃ©dia/baixa severidade detectados.")
                  print("")
                  print("ðŸ’¡ **AÃ§Ã£o recomendada:** Revisar quando possÃ­vel")
              else:
                  print("âœ… Nenhuma vulnerabilidade encontrada!")
          except Exception as e:
              print(f"âš ï¸ Erro ao gerar resumo: {e}")
          EOF
          else
            echo "## ðŸ›¡ï¸ AnÃ¡lise de SeguranÃ§a - Resumo" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ Resumo nÃ£o disponÃ­vel" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ“¦ Salvar resultados como artefatos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results
          path: |
            semgrep-result.json
          retention-days: 30
