name: Security Scan - Semgrep

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:

env:
  # ConfiguraÃ§Ã£o do Security Gate
  # true = quebra build se houver problemas crÃ­ticos
  # false = apenas alerta (recomendado para desenvolvimento)
  FAIL_ON_CRITICAL: false

jobs:
  security:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ðŸ” Instalar Semgrep
        run: pip install semgrep

      - name: ðŸ›¡ï¸ Rodar Semgrep (JSON)
        continue-on-error: true
        run: |
          semgrep --config=security/semgrep.yml --json src/ frontend/src/ > semgrep-result.json || true

      - name: ðŸšª Security Gate Inteligente
        id: security_gate
        continue-on-error: true
        run: |
          if [ -f semgrep-result.json ]; then
            if [ "${{ env.FAIL_ON_CRITICAL }}" = "true" ]; then
              python scripts/security_gate.py --file semgrep-result.json --fail-on-critical --show-all
            else
              python scripts/security_gate.py --file semgrep-result.json --show-all
            fi
          else
            echo "âš ï¸  Arquivo semgrep-result.json nÃ£o encontrado"
            echo "status=clean" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“Š Gerar Resumo do Security Gate
        if: always()
        run: |
          if [ -f security-gate-summary.json ]; then
            echo "## ðŸ›¡ï¸ Security Gate - Resumo" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            python3 << 'EOF'
          import json
          import sys
          
          try:
              with open('security-gate-summary.json', 'r') as f:
                  summary = json.load(f)
              
              total = summary.get('total', 0)
              critical = summary.get('critical', 0)
              warning = summary.get('warning', 0)
              info = summary.get('info', 0)
              status = summary.get('status', 'clean')
              
              # Emoji por status
              status_emoji = {
                  'clean': 'âœ…',
                  'info': 'ðŸ”µ',
                  'warning': 'ðŸŸ ',
                  'critical': 'ðŸ”´'
              }
              
              emoji = status_emoji.get(status, 'â“')
              
              print(f"{emoji} **Status:** {status.upper()}")
              print("")
              print("| Severidade | Quantidade |")
              print("|-----------|------------|")
              print(f"| ðŸ”´ Alta/CrÃ­tica | {critical} |")
              print(f"| ðŸŸ  MÃ©dia | {warning} |")
              print(f"| ðŸ”µ Baixa | {info} |")
              print(f"| **Total** | **{total}** |")
              print("")
              
              if critical > 0:
                  print("âš ï¸ **ATENÃ‡ÃƒO:** Problemas crÃ­ticos detectados!")
                  print("")
                  print("ðŸ’¡ **AÃ§Ã£o recomendada:** Corrigir antes de fazer merge")
              elif warning > 0 or info > 0:
                  print("â„¹ï¸ Problemas de mÃ©dia/baixa severidade detectados.")
                  print("")
                  print("ðŸ’¡ **AÃ§Ã£o recomendada:** Revisar quando possÃ­vel")
              else:
                  print("âœ… Nenhuma vulnerabilidade encontrada!")
          except Exception as e:
              print(f"âš ï¸ Erro ao gerar resumo: {e}")
          EOF
          else
            echo "## ðŸ›¡ï¸ Security Gate - Resumo" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ Resumo nÃ£o disponÃ­vel" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ“¦ Salvar resultados como artefatos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results
          path: |
            semgrep-result.json
            security-gate-summary.json
          retention-days: 30
